<!DOCTYPE html>
<html>
<head>
    <title>WSJF Story Board</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("MyCustomGird",{extend:"Rally.ui.grid.Grid",_requiresRefresh:function(){}}),Ext.define("Rally.ui.grid.plugin.DependenciesPopoverPlugin",{extend:"Ext.AbstractPlugin",alias:"plugin.rallydependenciesplugin",require:["Rally.ui.popover.DependenciesPopover"],init:function(e){this.callParent(arguments),this._delayedTask=Ext.create("Ext.util.DelayedTask",this._showPopover,this),this.cmp.on("afterrender",function(){this.cmp.getEl().on("mouseover",this._onMouseOver,this,{delegate:".formatted-id-link"}),this.cmp.getEl().on("mouseout",this._onMouseOut,this,{delegate:".formatted-id-link"})},this,{single:!0})},_onMouseOver:function(e,t){this._delayedTask.delay(500,null,null,[t])},_onMouseOut:function(){this._delayedTask.cancel()},_showPopover:function(e){var t=Ext.get(e),i=t.up(this.cmp.view.getDataRowSelector()),a=this.cmp.view.getRecord(i);if(a&&!Ext.getElementById("description-popover")){var l=t.dom.href&&_.last(t.dom.href.split("/detail/")),o=l&&Rally.util.Ref.getOidFromRef(l),n={context:this.cmp.context,field:"Description",target:t,targetSelector:"#"+t.id};o&&a.get("ObjectID")!==o?(n.oid=o,n.type=Rally.util.Ref.getTypeFromRef(l)):n.record=a,this.cmp.recordAction({description:"showing formatted id hover on grid"}),Rally.ui.popover.PopoverFactory.bake(n)}},destroy:function(){this._delayedTask&&this._delayedTask.cancel()}}),Ext.define("Rally.ui.bulk.RecordMenuFix",{override:"Rally.ui.menu.bulk.RecordMenu",_getMenuItems:function(){var e=this.getRecords(),t=[];t.push({xtype:"wsjfBulkSetRisk",id:"wsjfBulkSetRisk"}),t.push({xtype:"wsjfBulkSetValue",id:"wsjfBulkSetValue"}),t.push({xtype:"wsjfBulkSetTime",id:"wsjfBulkSetTime"}),t.push({xtype:"wsjfBulkSetPlan",id:"wsjfBulkSetPlan"}),_.each(t,function(t){Ext.apply(t,{records:e,store:this.store,onBeforeAction:this.onBeforeAction,onActionComplete:this.onActionComplete,context:this.getContext()})},this);var i=Ext.create("Rally.ui.menu.bulk.MenuItem",{text:"Bulk Edit",handler:function(){Ext.create("Rally.ui.dialog.BulkierEditDialog",{records:e})}});return t.push(i),t}}),Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",id:"wsjfApp",settingsScope:"project",stateful:!0,modelNames:["Defect"],onTimeboxScopeChange:function(e){this.callParent(arguments),gApp._startApp()},config:{defaultSettings:{useWSJFOverLoad:!0,useWSJFReadOnly:!0,useProjectField:!0,useStateField:!0,showFilter:!1,addStories:!1},wsjfField:{field:"WSJFScore",name:"WSJF Score"},wsjfCalcFields:[{field:"RROEValue",name:"RR/OE",menu:"wsjfBulkSetRisk",aboveLine:!0},{field:"UserBusinessValue",name:"Derived Value",menu:"wsjfBulkSetValue",aboveLine:!0},{field:"TimeCriticality",name:"Time Criticality",menu:"wsjfBulkSetTime",aboveLine:!0},{field:"PlanEstimate",name:"Plan Estimate",menu:"wsjfBulkSetPlan",aboveLine:!1},{field:"JobSize",name:"Job Size",menu:"wsjfBulkSetSize",aboveLine:!1}]},getSettingsFields:function(){return[{xtype:"textarea",fieldLabel:"Query",name:"query",anchor:"100%",cls:"query-field",margin:"0 70 0 0",plugins:[{ptype:"rallyhelpfield",helpId:194},"rallyfieldvalidationui"],validateOnBlur:!1,validateOnChange:!1,validator:function(e){try{return e&&Rally.data.wsapi.Filter.fromQueryString(e),!0}catch(e){return e.message}}},{xtype:"rallycheckboxfield",fieldLabel:"Overwrite WSJF on load",labelWidth:200,name:"useWSJFOverLoad"},{xtype:"rallycheckboxfield",fieldLabel:"Make WSJF field read-only",labelWidth:200,name:"useWSJFReadOnly"},{xtype:"rallycheckboxfield",fieldLabel:"Auto-sort on change",labelWidth:200,name:"useWSJFAutoSort"},{xtype:"rallycheckboxfield",fieldLabel:"Show State Field",labelWidth:200,name:"useStateField"},{xtype:"rallycheckboxfield",fieldLabel:"Show Project Field",labelWidth:200,name:"useProjectField"},{xtype:"rallycheckboxfield",fieldLabel:"Show Advanced filter",labelWidth:200,name:"showFilter"},{xtype:"rallycheckboxfield",fieldLabel:"Include Stories",labelWidth:200,name:"addStories"}]},launch:function(){Rally.data.util.PortfolioItemHelper.getPortfolioItemTypes().then({scope:this,success:function(e){this.portfolioItemTypes=_.sortBy(e,function(e){return e.get("Ordinal")}),this.modelNames=_.union(this.modelNames,[this.portfolioItemTypes[0].get("TypePath")]),this._piTypesLoaded()}})},_piTypesLoaded:function(){gApp=this,this.getSetting("addStories")&&(this.modelNames=_.union(this.modelNames,["HierarchicalRequirement"])),this.add({xtype:"container",id:"headerBox",layout:"column",border:5,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"}}),this.add({xtype:"container",id:"filterBox"}),Ext.getCmp("headerBox").add({xtype:"rallybutton",labelWidth:150,text:"Fetch Items",id:"goDoIt",margin:10,handler:function(){gApp._startApp()},scope:this,align:"left"}),gApp.getSetting("showFilter")&&Ext.getCmp("headerBox").add({xtype:"rallyinlinefiltercontrol",name:"inlineFilter",itemId:"inlineFilter",margin:"10 10 10 10",context:this.getContext(),height:26,inlineFilterButtonConfig:{stateful:!0,stateId:this.getContext().getScopedStateId("inline-filter"),context:this.getContext(),modelNames:gApp.modelNames,filterChildren:!1,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["ArtifactSearch","Owner","ScheduleState"]}},listeners:{inlinefilterchange:this._onFilterChange,inlinefilterready:this._onFilterReady,scope:this}}}),gApp.timeboxscope=this.getContext().getTimeboxScope()},_onFilterChange:function(e){gApp.advFilters=e.getTypesAndFilters().filters,gApp._startApp()},_onFilterReady:function(e){Ext.getCmp("filterBox").add(e)},_getFilters:function(e){var t=[],i=this.getContext().getTimeboxScope();if(i){var a=i.getQueryFilter();a.value&&t.push(a.value.config)}var l=gApp.getSetting("query");if(l){var o=Rally.data.wsapi.Filter.fromQueryString(l);o.itemId=o.toString(),t.push(o)}return this.getSetting("showFilter")&&this.advFilters.length>0&&Ext.Array.each(this.advFilters,function(e){t.push(e)}),t},_startApp:function(){var e=Ext.getCmp("piGrid");e&&e.destroy();var t=["FormattedID",{dataIndex:"Name"}];gApp.getSetting("useStateField")&&(t.push({dataIndex:"ScheduleState",text:"ScheduleState",align:"center"}),t.push({dataIndex:"State",text:"State",align:"center"})),gApp.getSetting("useProjectField")&&t.push({dataIndex:"Project",text:"Project",align:"center"}),_.each(gApp.wsjfCalcFields,function(e){t.push({dataIndex:e.field,text:e.name,align:"center",listeners:{afterrender:function(){thisMenu=Ext.create(e.menu),helpHTML=thisMenu.getHelp(),Ext.create("Rally.ui.tooltip.ToolTip",{target:this.getEl(),html:helpHTML})}}})}),wsjfCol={dataIndex:gApp.wsjfField.field,text:gApp.wsjfField.name,align:"center",listeners:{afterrender:function(){Ext.create("Rally.ui.tooltip.ToolTip",{target:this.getEl(),html:"<p><strong>WSJF = (RR/OE + Derived Value + Time Criticality)/Job Size</strong></p>"})}}},gApp.getSetting("useWSJFReadOnly")&&(wsjfCol=_.merge(wsjfCol,{editor:null})),t.push(wsjfCol);var i=gApp.wsjfField.field,a=["FormattedID","PreliminaryEstimate","Name","Release","Project","ScheduleState","State",i];_.each(gApp.wsjfCalcFields,function(e){a.push(e.field)});var l=Ext.create("Rally.ui.grid.Grid",{id:"piGrid",margin:"40, 10, 40, 10",plugins:["rallydependenciesplugin"],columnCfgs:t,bulkEditConfig:{showEdit:!1,showTag:!1,showParent:!1,showRemove:!1},context:this.getContext(),enableBulkEdit:!0,enableRanking:!0,enableColumnResize:!0,sortableColumns:!0,storeConfig:{pageSize:200,batchAction:!0,model:gApp.modelNames,sorters:[{property:"DragAndDropRank",direction:"ASC"}],fetch:a,filters:gApp._getFilters()},listeners:{inlineeditsaved:function(e,t,i){this._saveWSJF(t)},load:function(e){if(gApp.getSetting("useWSJFOverLoad")){Ext.getCmp("headerBox").setLoading("Updating WSJF...");var t=e.getRecords(),a=!0;_.each(t,function(e){if(e.hasField(i)){var t=gApp._calcWSJF(e).toFixed(2);t!==(e.get(i)||0).toFixed(2)&&(e.set(i,t),a=!1)}}),a&&Ext.getCmp("headerBox").setLoading(!1),this._storeSync(e)}}},_saveRecord:function(e){var t=Ext.create("Deft.Deferred");return e.save({success:function(e){t.resolve(e)},failure:function(e){t.reject(e)}}),t.promise},_storeSync:function(e){if(e.getModifiedRecords().length>0){var t=[],i=this;_.each(e.getRecords(),function(e){t.push(i._saveRecord(e))}),Deft.Promise.all(t).then({success:function(){console.log("Completed "+t.length+" saves.")},failure:function(){console.log("Failed to save all records.")}}).always(function(){Ext.getCmp("headerBox").setLoading(!1)})}},_saveWSJF:function(e){var t=gApp._calcWSJF(e),i=e.get(gApp.wsjfField.field)?e.get(gApp.wsjfField.field).toFixed(2):0;(t=t.toFixed(2))!==i&&(e.set(gApp.wsjfField.field,t),e.save({callback:function(){gApp.getSetting("useWSJFAutoSort")&&Ext.getCmp("piGrid").refresh()}}))}});this.add(l)},_calcWSJF:function(e){var t=0,i=0;return _.each(_.filter(gApp.wsjfCalcFields,function(e){return e.aboveLine}),function(i){t+=e.get(i.field)||0}),_.each(_.filter(gApp.wsjfCalcFields,function(e){return!e.aboveLine}),function(t){i+=e.get(t.field)||0}),t/(i>0?i:1)},_recordToRank:0,_rankingRecord:null,_store:null,_storeRecords:function(){this._store=Ext.getCmp("piGrid").store,this._recordToRank=0,this._rankingRecord=this._store.data.items[this._recordToRank],!0===Ext.getCmp("globalCheck").value?this._rankingRecord.save({rankTo:"TOP",callback:function(e,t,i){this._recordToRank+=1,this._saveNextRecord()},scope:this}):(this._recordToRank+=1,this._saveNextRecord())},_saveNextRecord:function(){if(this._recordToRank<this._store.totalCount){var e=this._store.data.items[this._recordToRank];Rally.data.Ranker.rankRelative({recordToRank:e,relativeRecord:this._rankingRecord,position:"after",saveOptions:{callback:function(e,t,i){this._recordToRank+=1,this._rankingRecord=e,this._saveNextRecord()},scope:this}})}}}),Ext.define("dataModel",{extend:"Ext.data.Model",fields:[{name:"Name",type:"string"},{name:"Value",type:"integer"},{name:"Description",type:"string"}]}),Ext.define("Rally.ui.grid.localWSJFBulkSet",{extend:Rally.ui.menu.bulk.MenuItem,alias:"widget.localWSJFBulkSet",_makeHelpFromData:function(){return html="",_.each(this.config.data,function(e){html+="<p><strong>"+e.Name+"("+e.Value+"):  "+e.Description+"</strong></p>"}),html},_onSetParam:function(e,t){var i=Ext.create("Ext.data.Store",{autoLoad:!0,model:"dataModel",data:this.config.data,proxy:{type:"memory",reader:{type:"json",root:"dataValues"}}}),a=Ext.create("Ext.form.ComboBox",{id:"localBox",store:i,queryMode:"local",displayField:"Name",valueField:"Value"});Ext.create("Rally.ui.dialog.Dialog",{id:"localChooser",autoShow:!0,draggable:!0,width:300,records:this.records,title:e,items:a,buttons:[{text:"OK",handler:function(e,i,a){_.each(this.records,function(e){e.set(t,Ext.getCmp("localBox").value);var i=gApp._calcWSJF(e).toFixed(2);e.set(gApp.wsjfField.field,i),e.save({callback:function(){Ext.getCmp("wsjfApp").getSetting("useWSJFAutoSort")&&Ext.getCmp("piGrid").refresh()}})}),Ext.getCmp("localChooser").destroy()},scope:this},{text:"Cancel",handler:function(){Ext.getCmp("localChooser").destroy()}}]})},getHelp:function(){return this._makeHelpFromData()}}),Ext.define("wsjfBulkSetRisk",{extend:Rally.ui.grid.localWSJFBulkSet,alias:"widget.wsjfBulkSetRisk",config:{text:"Risk Reduction",handler:function(e,t,i){this._onSetParam("Choose RR/OE potential","RROEValue")},data:[{Name:"None",Value:0,Description:""},{Name:"Minimal",Value:1,Description:""},{Name:"Low",Value:2,Description:""},{Name:"Medium",Value:3,Description:""},{Name:"High",Value:5,Description:""},{Name:"Very High",Value:8,Description:""},{Name:"Extreme",Value:13,Description:""}]}}),Ext.define("wsjfBulkSetValue",{extend:Rally.ui.grid.localWSJFBulkSet,alias:"widget.wsjfBulkSetValue",config:{text:"Business Value",handler:function(e,t,i){this._onSetParam("Choose Derived Value","UserBusinessValue")},data:[{Name:"None",Value:0,Description:""},{Name:"Minimal",Value:1,Description:""},{Name:"Low",Value:2,Description:""},{Name:"Medium",Value:3,Description:""},{Name:"High",Value:5,Description:""},{Name:"Very High",Value:8,Description:""},{Name:"Extreme",Value:13,Description:""}]}}),Ext.define("wsjfBulkSetTime",{extend:Rally.ui.grid.localWSJFBulkSet,alias:"widget.wsjfBulkSetTime",config:{text:"Time Criticality",handler:function(e,t,i){this._onSetParam("Choose Urgency Rating","TimeCriticality")},data:[{Name:"None",Value:0,Description:"No urgency"},{Name:"Minimal",Value:1,Description:"This year"},{Name:"Low",Value:2,Description:"Within 6 months"},{Name:"Medium",Value:3,Description:"This quarter"},{Name:"High",Value:5,Description:"This month"},{Name:"Very High",Value:8,Description:"This week"},{Name:"Extreme",Value:13,Description:"Immediately"}]}}),Ext.define("wsjfBulkSetSize",{extend:Rally.ui.grid.localWSJFBulkSet,alias:"widget.wsjfBulkSetSize",config:{text:"Size",handler:function(e,t,i){this._onSetParam("Choose Size/Effort Rating","JobSize")},data:[{Name:"XS",Value:1,Description:"Less than 1 week"},{Name:"S",Value:2,Description:"1 - 3 weeks"},{Name:"M",Value:3,Description:"1 - 2 months"},{Name:"L",Value:5,Description:"3 - 6 months"},{Name:"XL",Value:8,Description:"6 - 9 months"},{Name:"XXL",Value:13,Description:"9 - 18 months"},{Name:"XXXL",Value:21,Description:"Two years or more"}]}}),Ext.define("wsjfBulkSetPlan",{extend:Rally.ui.grid.localWSJFBulkSet,alias:"widget.wsjfBulkSetPlan",config:{text:"Size",handler:function(e,t,i){_.uniq(_.map(e.records,function(e){return e.get("_type")})).length>1?Rally.ui.notify.Notifier.show({message:"Please select only one type of item"}):(e.records[0].data._type.search(!1),this._onSetParam("Choose Size/Effort Rating","PlanEstimate"))},data:[{Name:"XS",Value:1,Description:"Less than 1 week"},{Name:"S",Value:2,Description:"1 - 3 weeks"},{Name:"M",Value:3,Description:"1 - 2 months"},{Name:"L",Value:5,Description:"3 - 6 months"},{Name:"XL",Value:8,Description:"6 - 9 months"},{Name:"XXL",Value:13,Description:"9 - 18 months"},{Name:"XXXL",Value:21,Description:"Two years or more"}]}});
                !function(){var t=window.Ext4||window.Ext;t.define("Rally.data.wsapi.collection.Proxy",{extend:"Rally.data.wsapi.Proxy",requires:["Rally.data.wsapi.ProxyBase"],alias:["proxy.Rally.data.WsapiCollectionProxy","proxy.rallywsapicollectionproxy"],alternateClassName:["Rally.data.WsapiCollectionProxy"],mixins:{proxy:"Rally.data.wsapi.ProxyBase"},urlMappings:{create:"add",destroy:"remove"},statics:{MAX_ARTIFACTS_PER_OPERATION:25},constructor:function(){this.callParent(arguments)},buildRequest:function(t){var a=this.callParent(arguments);return a.requester=this.requester,a},buildUrl:function(t){return t.url=this.url,this.urlMappings[t.action]&&(t.url+="/"+this.urlMappings[t.action]),t.url},getMethod:function(t){return"read"===t.action?"GET":"POST"},batch:function(a,r){var e,i,n,o,s,l,c=this,p=c.batchActions;void 0===a.operations&&(a={operations:a,listeners:r}),a.batch?t.isDefined(a.batch.runOperation)&&(e=t.applyIf(a.batch,{proxy:c,listeners:{}})):a.batch={proxy:c,listeners:a.listeners||{}},e||(e=new t.data.Batch(a.batch)),e.on("complete",t.bind(c.onBatchComplete,c,[a],0)),o=(n=c.batchOrder.split(",")).length;var u=function(a){e.add(new t.data.Operation({action:s,records:[a]}))},d=function(a){p?e.add(new t.data.Operation({action:s,records:a})):_.each(a,u)};for(l=0;l<o;l++){s=n[l],i=a.operations[s];var h=this._splitBatch(i);_.each(h,d,h)}return e.start(),e},_splitBatch:function(t){return _.chain(t).groupBy(function(t,a){return Math.floor(a/this.self.MAX_ARTIFACTS_PER_OPERATION)},this).toArray().value()}})}();

            Rally.launchApp('CustomApp', {
                name:"WSJF Story Board",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
